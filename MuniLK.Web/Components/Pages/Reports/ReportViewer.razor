@page "/reports-reportviewer"
@rendermode InteractiveServer
@using Microsoft.JSInterop
@using Microsoft.AspNetCore.Components
@using MuniLK.Application.Reports.DTOs
@inject IHttpClientFactory HttpClientFactory
@inject IJSRuntime JSRuntime
@inject MuniLK.Web.Services.ErrorNotifier ErrorNotifier

<div id="report-viewer" style="width: 100%;height: 950px"></div>
@if(!string.IsNullOrEmpty(_errorMessage))
{
    <div class="alert alert-warning mt-2">@_errorMessage</div>
}

@code {
    private readonly BoldReportViewerOptions _viewerOptions = new();
    private string? _errorMessage;

    private async Task RenderReportViewerAsync()
    {
        _viewerOptions.ReportName = "NewTestReport";
        var client = HttpClientFactory.CreateClient("AuthorizedClient");
        _viewerOptions.ServiceURL = client.BaseAddress + "api/BoldReportsAPI";
        await JSRuntime.InvokeVoidAsync("BoldReports.RenderViewer", "report-viewer", _viewerOptions);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        try
        {
            // Optionally ensure script readiness before calling
            var ready = await JSRuntime.InvokeAsync<bool>("eval", "!!(window.jQuery && window.jQuery.fn && window.jQuery.fn.boldReportViewer)");
            if (!ready)
            {
                throw new JSException("Bold Reports scripts not loaded yet.");
            }
            await RenderReportViewerAsync();
        }
        catch (JSException jsEx)
        {
            _errorMessage = jsEx.Message;
            await ErrorNotifier.NotifyAsync(jsEx, "ReportViewer JS");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
            await ErrorNotifier.NotifyAsync(ex, "ReportViewer");
            StateHasChanged();
        }
    }
}
