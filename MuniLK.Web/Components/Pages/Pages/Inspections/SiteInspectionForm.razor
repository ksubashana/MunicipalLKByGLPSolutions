@using Microsoft.AspNetCore.Components.Forms
@using MuniLK.Application.BuildingAndPlanning.DTOs
@using MuniLK.Application.Documents.DTOs
@using MuniLK.Application.Services.DTOs
@using MuniLK.Domain.Constants
@using MuniLK.Domain.Constants.Flows
@using MuniLK.Web.Clients
@using MuniLK.Web.Components.Pages.Generic.Documents
@using MuniLK.Web.Components.Pages.Notifications
@using MuniLK.Web.Interfaces
@using Syncfusion.Blazor.Buttons
@using Syncfusion.Blazor.Calendars
@using Syncfusion.Blazor.DropDowns
@using Syncfusion.Blazor.Inputs
@using Syncfusion.Blazor.Popups
@using Syncfusion.Blazor.Grids
@using Microsoft.JSInterop
@using System.Net.Http.Json
@using MuniLK.Web.Services
@inject IHttpClientFactory HttpClientFactory
@inject IJSRuntime JS
@inject ILookupService LookupService
@inject IConfiguration Config
@inject DocumentClient DocClient
@inject ErrorNotifier ErrorNotifier
@inject ISafeExecutor SafeExecutor


<div class="container-xxl py-3">
    <div class="card shadow-sm">
        <div class="card-header bg-light d-flex align-items-center justify-content-between">
            <h5 class="mb-0">Site Inspection Report</h5>
            <div class="d-flex align-items-center gap-2">
                @if (!string.IsNullOrWhiteSpace(ApplicationNumber))
                {
                    <span class="badge bg-primary-subtle text-primary">App No: @ApplicationNumber</span>
                }
            </div>
        </div>
        <div class="card-body">
            <AlertToast @ref="MyToast" />

            <EditForm Model="@Model" OnValidSubmit="HandleValidSubmit">
                <DataAnnotationsValidator />
                <ValidationSummary class="text-danger" />
                @if (MetadataLocked)
                {
                    <small class="text-muted">Locked (reschedule in previous step to change)</small>
                }
                <!-- Core Inspection Details -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="text-primary mb-3">üìã Inspection Overview</h6>
                    </div>
                    
                    <div class="col-md-6">
                        <label class="form-label">Inspection Status <span class="text-danger">*</span></label>
                        <SfDropDownList TValue="InspectionStatus" TItem="InspectionStatusOption" 
                                      @bind-Value="Model.Status" DataSource="@InspectionStatusOptions"
                                        Placeholder="Select Status" CssClass="form-control" Enabled="@( !MetadataLocked )">
                            <DropDownListFieldSettings Value="Value" Text="Text" />
                        </SfDropDownList>
                        <ValidationMessage For="@(() => Model.Status)" />
                    </div>
                    
                    <div class="col-md-6">
                        <label class="form-label">Inspection Date <span class="text-danger">*</span></label>
                        <SfDatePicker TValue="DateTime" @bind-Value="Model.InspectionDate"
                                      Enabled="@( !MetadataLocked )"
                                      CssClass="form-control" />
                        <ValidationMessage For="@(() => Model.InspectionDate)" />
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="form-label">Assigned Inspector</label>
                        <SfTextBox @bind-Value="Model.InspectionAssignedTo" 
                                   CssClass="form-control" Placeholder="" Enabled="@( !MetadataLocked )" />
                        <!-- Multi-select of inspectors; selected names joined into Model.OfficersPresent -->
                        @* <SfMultiSelect TValue="List<string>" TItem="InspectorOption"
                                       @bind-Value="SelectedInspectorIds"
                                       DataSource="InspectorOptions"
                                       Enabled="@( !MetadataLocked )"
                                       Placeholder="Select officers present"
                                       Mode="@VisualMode.CheckBox"
                                       ShowSelectAll="true"
                                       ClosePopupOnSelect="false"
                                       CssClass="form-control">
                            <MultiSelectFieldSettings Value="Id" Text="Name" />
                        </SfMultiSelect> *@
                    </div>
                    
                    <div class="col-md-6">
                        <label class="form-label">Property Address</label>
                        <div class="input-group">
                            <SfTextBox @bind-Value="Model.PropertyAddress" Width="80%"
                                       Placeholder="Enter property address" CssClass="form-control"
                                       Enabled="@( !MetadataLocked )" />
                            <button type="button" class="btn btn-outline-secondary" @onclick="ShowMapDialog" title="View on map">
                                <i class="fas fa-map-marker-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-12">
                        <label class="form-label">General Remarks</label>
                        <SfTextBox @bind-Value="Model.Remarks" Multiline="true" 
                                 CssClass="form-control" Placeholder="General inspection notes" />
                    </div>
                </div>

                <!-- Site Conditions Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="text-primary mb-3">üèóÔ∏è Site Conditions Verification</h6>
                    </div
                    
                    <!-- Access Road Width -->
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Access Road Width Condition</label>
                        <div class="d-flex gap-3">
                            <SfRadioButton TChecked="bool?" @bind-Checked="Model.AccessRoadWidthCondition" 
                                         Value="true" Name="accessRoad" Label="Yes" />
                            <SfRadioButton TChecked="bool?" @bind-Checked="Model.AccessRoadWidthCondition" 
                                         Value="false" Name="accessRoad" Label="No" />
                        </div>
                    </div>
                    <div class="col-md-8 mb-3">
                        <label class="form-label">Notes</label>
                        <SfTextBox @bind-Value="Model.AccessRoadWidthNotes" CssClass="form-control" />
                    </div>

                    <!-- Boundary Verification -->
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Boundary Verification</label>
                        <div class="d-flex gap-3">
                            <SfRadioButton TChecked="bool?" @bind-Checked="Model.BoundaryVerification" 
                                         Value="true" Name="boundary" Label="Yes" />
                            <SfRadioButton TChecked="bool?" @bind-Checked="Model.BoundaryVerification" 
                                         Value="false" Name="boundary" Label="No" />
                        </div>
                    </div>
                    <div class="col-md-8 mb-3">
                        <label class="form-label">Notes</label>
                        <SfTextBox @bind-Value="Model.BoundaryVerificationNotes" CssClass="form-control" />
                    </div>

                    <!-- Topography -->
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Topography</label>
                        <div class="d-flex gap-3">
                            <SfRadioButton TChecked="bool?" @bind-Checked="Model.Topography" 
                                         Value="true" Name="topography" Label="Suitable" />
                            <SfRadioButton TChecked="bool?" @bind-Checked="Model.Topography" 
                                         Value="false" Name="topography" Label="Unsuitable" />
                        </div>
                    </div>
                    <div class="col-md-8 mb-3">
                        <label class="form-label">Notes</label>
                        <SfTextBox @bind-Value="Model.TopographyNotes" CssClass="form-control" />
                    </div>

                    <!-- Existing Structures -->
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Existing Structures</label>
                        <div class="d-flex gap-3">
                            <SfRadioButton TChecked="bool?" @bind-Checked="Model.ExistingStructures" 
                                         Value="true" Name="structures" Label="Present" />
                            <SfRadioButton TChecked="bool?" @bind-Checked="Model.ExistingStructures" 
                                         Value="false" Name="structures" Label="None" />
                        </div>
                    </div>
                    <div class="col-md-8 mb-3">
                        <label class="form-label">Notes</label>
                        <SfTextBox @bind-Value="Model.ExistingStructuresNotes" CssClass="form-control" />
                    </div>

                    <!-- Encroachments -->
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Encroachments/Reservations</label>
                        <div class="d-flex gap-3">
                            <SfRadioButton TChecked="bool?" @bind-Checked="Model.EncroachmentsReservations" 
                                         Value="true" Name="encroachments" Label="Present" />
                            <SfRadioButton TChecked="bool?" @bind-Checked="Model.EncroachmentsReservations" 
                                         Value="false" Name="encroachments" Label="None" />
                        </div>
                    </div>
                    <div class="col-md-8 mb-3">
                        <label class="form-label">Notes</label>
                        <SfTextBox @bind-Value="Model.EncroachmentsReservationsNotes" CssClass="form-control" />
                    </div>
                </div>

                <!-- Compliance Checks Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="text-primary mb-3">‚úÖ Compliance Checks</h6>
                    </div>
                    
                    <!-- Matches Survey Plan -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Matches Survey Plan</label>
                        <div class="d-flex gap-3">
                            <SfRadioButton TChecked="bool?" @bind-Checked="Model.MatchesSurveyPlan" 
                                         Value="true" Name="survey" Label="Yes" />
                            <SfRadioButton TChecked="bool?" @bind-Checked="Model.MatchesSurveyPlan" 
                                         Value="false" Name="survey" Label="No" />
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Notes</label>
                        <SfTextBox @bind-Value="Model.MatchesSurveyPlanNotes" CssClass="form-control" />
                    </div>

                    <!-- Zoning Compatible -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Zoning Compatible</label>
                        <div class="d-flex gap-3">
                            <SfRadioButton TChecked="bool?" @bind-Checked="Model.ZoningCompatible" 
                                         Value="true" Name="zoning" Label="Yes" />
                            <SfRadioButton TChecked="bool?" @bind-Checked="Model.ZoningCompatible" 
                                         Value="false" Name="zoning" Label="No" />
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Notes</label>
                        <SfTextBox @bind-Value="Model.ZoningCompatibleNotes" CssClass="form-control" />
                    </div>

                    <!-- Setbacks -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Setbacks Observed</label>
                        <div class="d-flex gap-3">
                            <SfRadioButton TChecked="bool?" @bind-Checked="Model.SetbacksObserved" 
                                         Value="true" Name="setbacks" Label="Yes" />
                            <SfRadioButton TChecked="bool?" @bind-Checked="Model.SetbacksObserved" 
                                         Value="false" Name="setbacks" Label="No" />
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Notes</label>
                        <SfTextBox @bind-Value="Model.SetbacksObservedNotes" CssClass="form-control" />
                    </div>

                    <!-- Detailed Setbacks -->
                    <div class="col-12 mb-3">
                        <label class="form-label">Specific Setbacks</label>
                        <div class="row">
                            <div class="col-md-4">
                                <SfCheckBox @bind-Checked="Model.FrontSetback" Label="Front Setback" />
                            </div>
                            <div class="col-md-4">
                                <SfCheckBox @bind-Checked="Model.RearSetback" Label="Rear Setback" />
                            </div>
                            <div class="col-md-4">
                                <SfCheckBox @bind-Checked="Model.SideSetbacks" Label="Side Setbacks" />
                            </div>
                        </div>
                    </div>

                    <!-- Environmental Concerns -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Environmental Concerns</label>
                        <div class="d-flex gap-3">
                            <SfRadioButton TChecked="bool?" @bind-Checked="Model.EnvironmentalConcerns" 
                                         Value="true" Name="environmental" Label="Present" />
                            <SfRadioButton TChecked="bool?" @bind-Checked="Model.EnvironmentalConcerns" 
                                         Value="false" Name="environmental" Label="None" />
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Notes</label>
                        <SfTextBox @bind-Value="Model.EnvironmentalConcernsNotes" CssClass="form-control" />
                    </div>
                </div>

                <!-- Decision Support Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="text-primary mb-3">üìã Decision Support</h6>
                    </div
                    
                    <div class="col-12 mb-3">
                        <label class="form-label">Required Modifications</label>
                        <SfTextBox @bind-Value="Model.RequiredModifications" Multiline="true" 
                                 CssClass="form-control" Placeholder="Describe any required modifications" />
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label">Clearances Required</label>
                        <SfMultiSelect TValue="List<Guid>" TItem="ClearanceTypeOption" 
                                     @bind-Value="Model.ClearanceOptionItemIds" DataSource="@ClearanceTypeOptions" 
                                     Placeholder="Select required clearances" CssClass="form-control"
                                     Mode="@VisualMode.CheckBox">
                            <MultiSelectFieldSettings Value="Value" Text="Text" />
                        </SfMultiSelect>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label">Final Recommendation <span class="text-danger">*</span></label>
                        <SfDropDownList TValue="FinalRecommendation" TItem="FinalRecommendationOption" 
                                      @bind-Value="Model.FinalRecommendation" DataSource="@FinalRecommendationOptions" 
                                      Placeholder="Select Recommendation" CssClass="form-control">
                            <DropDownListFieldSettings Value="Value" Text="Text" />
                        </SfDropDownList>
                        <ValidationMessage For="@(() => Model.FinalRecommendation)" />
                    </div>
                </div>
                                    <!-- DOCUMENT UPLOAD -->
                    <div class="card shadow-sm position-relative">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Document Upload</h5>
                        </div>
                        <div class="card-body">

                        @if (ApplicationId != Guid.Empty && ModuleId != Guid.Empty && DocumentCategory != Guid.Empty)
                                {
                                    <DocumentUploader Label="Upload Required Documents for Building Application (‡∂Ö‡∂∫‡∂Ø‡∑î‡∂∏‡∑ä‡∂¥‡∂≠ ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫ ‡∂Ω‡∑ö‡∂õ‡∂± ‡∂ã‡∂©‡∑î‡∂ú‡∂≠ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±)"
                                                      Required="true"
                                                      OnUploaded="OnPlanUploaded"
                                                      ModuleId="@ModuleId"
                                                      EntityId="@ApplicationId"
                                                      LinkContext="@MuniLK.Domain.Constants.LookupValues.DocumentTypes.Inspection.ToString()"
                                                      DocumentType="@MuniLK.Domain.Constants.LookupValues.DocumentTypes.Inspection.ToString()"
                                                      DocumentTypeId="@DocumentTypeId"
                                                      Enabled="true" />
                                }
                                else
                                {
                                    <p>Loading document uploader...</p>
                                }
                        </div>
                    </div>
                

                <!-- Submit Button -->
                <div class="row">
                    <div class="col-12">
                        <SfButton IsPrimary="true" type="submit" Disabled="@IsSubmitting" CssClass="me-2">
                            @(IsSubmitting ? "Submitting..." : "Submit Site Inspection")
                        </SfButton>
                        <SfButton type="button" OnClick="@(() => OnCancel.InvokeAsync())" Disabled="@IsSubmitting">Cancel</SfButton>
                    </div>
                </div>
            </EditForm>

            <!-- Documents Section -->
            <div class="row mb-4">
                <div class="col-12">
                    <h6 class="text-primary mb-3">üìÑ Application Documents</h6>
                    @if (ApplicationDocuments?.Any() == true)
                    {
                        <SfGrid TValue="DocumentLinkResponse" DataSource="@ApplicationDocuments"
                                AllowPaging="false" AllowSorting="true">
                            <GridColumns>
                                <GridColumn Field="FileName" HeaderText="Document" Width="200" />
                                <GridColumn Field="DocumentTypeName" HeaderText="Type" Width="120" />
                                <GridColumn Field="UploadedDate" HeaderText="Date" Format="d" Width="100" />
                                <GridColumn HeaderText="Actions" Width="120" TextAlign="TextAlign.Center">
                                    <Template Context="docContext">
                                        @{
                                            var doc = (docContext as DocumentLinkResponse);
                                        }
                                        <SfButton IconCss="fas fa-eye" CssClass="btn-sm btn-outline-primary me-1"
                                                  @onclick="() => PreviewDocument(doc)" />
                                        <SfButton IconCss="fas fa-download" CssClass="btn-sm btn-outline-secondary"
                                                  @onclick="() => DownloadDocument(doc)" />
                                    </Template>
                                </GridColumn>
                            </GridColumns>
                        </SfGrid>
                    }
                    else
                    {
                        <p class="text-muted">No documents available for this application.</p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Document Preview Dialog -->
<SfDialog @bind-Visible="@IsPreviewDialogVisible" Width="1400px" Height="600px" ShowCloseIcon="true">
    <DialogTemplates>
        <Header>
            <div>Document Preview - @(SelectedPreviewDocument?.FileName)</div>
        </Header>
        <Content>
            @if (SelectedPreviewDocument != null)
            {
                <div class="row">
                    <div class="col-8">
                        @if (@DocClient.IsImageFile(SelectedPreviewDocument.FileExtension))
                        {
                            <img src="@DocClient.GetDocumentPreviewUrl(SelectedPreviewDocument.DocumentId)"
                                 class="img-fluid" alt="@SelectedPreviewDocument.FileName" />
                        }
                        else if (@DocClient.IsPdfFile(SelectedPreviewDocument.FileExtension))
                        {
                            <iframe src="@DocClient.GetDocumentPreviewUrl(SelectedPreviewDocument.DocumentId)"
                                    width="100%" height="500px"></iframe>
                        }
                        else if (@DocClient.IsWordFile(SelectedPreviewDocument.FileExtension))
                        {
                            <iframe src="https://view.officeapps.live.com/op/embed.aspx?src=http://localhost:5164/api/Documents/@(SelectedPreviewDocument.DocumentId)/preview"
                                    width="100%" height="500px"></iframe>
                        }
                        else
                        {
                            <div class="text-center p-4">
                                <i class="fas fa-file fa-3x text-muted mb-3"></i>
                                <p>Preview not available for this file type.</p>
                                <SfButton @onclick="() => DownloadDocument(SelectedPreviewDocument)">
                                    <i class="fas fa-download me-2"></i>Download File
                                </SfButton>
                            </div>
                        }


                        @* @if (IsImageFile(SelectedPreviewDocument.FileExtension))
                        {
                            <img src="@GetDocumentPreviewUrl(SelectedPreviewDocument.DocumentId)" class="img-fluid" alt="@SelectedPreviewDocument.FileName" />
                        }
                        else if (IsPdfFile(SelectedPreviewDocument.FileExtension))
                        {
                            <iframe src="@GetDocumentPreviewUrl(SelectedPreviewDocument.DocumentId)" width="100%" height="500px"></iframe>
                        }
                        else
                        {
                            <div class="text-center p-4">
                                <i class="fas fa-file fa-3x text-muted mb-3"></i>
                                <p>Preview not available for this file type.</p>
                                <SfButton @onclick="() => DownloadDocument(SelectedPreviewDocument)">
                                    <i class="fas fa-download me-2"></i>Download File
                                </SfButton>
                            </div>
                        } *@
                    </div>
                    <div class="col-4">
                        <h6>Document Information</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Filename:</strong></td><td>@SelectedPreviewDocument.FileName</td></tr>
                            <tr><td><strong>Type:</strong></td><td>@SelectedPreviewDocument.DocumentTypeName</td></tr>
                            <tr><td><strong>Size:</strong></td><td>@DocClient.FormatFileSize(SelectedPreviewDocument.FileSize)</td></tr>
                            <tr><td><strong>Uploaded:</strong></td><td>@SelectedPreviewDocument.UploadedDate.ToString("dd/MM/yyyy")</td></tr>
                            <tr><td><strong>Uploaded By:</strong></td><td>@SelectedPreviewDocument.UploadedBy</td></tr>
                        </table>
                        <SfButton IsPrimary="true" @onclick="() => DownloadDocument(SelectedPreviewDocument)">
                            <i class="fas fa-download me-2"></i>Download
                        </SfButton>
                    </div>
                </div>
            }
        </Content>
    </DialogTemplates>
</SfDialog>

<!-- Map Dialog -->
<SfDialog @bind-Visible="_showMapDialog" Width="800px" Height="600px" ShowCloseIcon="true">
    <DialogTemplates>
        <Header>
            <div>Location Map</div>
        </Header>
        <Content>
            @if (!string.IsNullOrWhiteSpace(PropertyAddress))
            {
                <iframe width="100%" height="520" style="border:0" loading="lazy" allowfullscreen
                        referrerpolicy="no-referrer-when-downgrade"
                        src="@GetGoogleMapsEmbedUrl(PropertyAddress)"></iframe>
            }
            else
            {
                <p class="text-muted">Address unavailable.</p>
            }
        </Content>
    </DialogTemplates>
</SfDialog>

@code {
    [Parameter] public Guid ApplicationId { get; set; }
    [Parameter] public Guid? AssignmentId { get; set; }
    [Parameter] public Guid DocumentTypeId { get; set; }
    [Parameter] public Guid DocumentCategory { get; set; }
    [Parameter] public Guid ModuleId { get; set; }
    [Parameter] public string? ApplicationNumber { get; set; }
    [Parameter] public EventCallback<SiteInspectionRequest> OnSubmit { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public DateTime? PrefilledInspectionDate { get; set; }
    [Parameter] public string? PrefilledAssignedTo { get; set; }
    [Parameter] public string? PropertyAddress { get; set; } // new
    [Parameter] public bool LockMetadata { get; set; } = false;
    [Parameter] public EventCallback OnInspectionCompleted { get; set; }

    private bool MetadataLocked => LockMetadata;
    private List<ClearanceTypeOption> ClearanceTypeOptions = new();
    private SiteInspectionRequest Model = new();
    private bool IsSubmitting = false;
    private bool IsInspectionAssigned = false;
    private string? SelectedInspectorIdForAssignment = null;
    private DateTime AssignmentDate = DateTime.Today;
    private string? AssignmentNotes = null;
    private List<DocumentLinkResponse> ApplicationDocuments = new();
    private bool IsPreviewDialogVisible = false;
    private DocumentLinkResponse? SelectedPreviewDocument = null;
    private AlertToast? MyToast;
    private List<InspectorOption> InspectorOptions = new();

    private List<InspectionStatusOption> InspectionStatusOptions = new()
    {
        new() { Value = InspectionStatus.Pending, Text = "Pending" },
        new() { Value = InspectionStatus.Approve, Text = "Approve" },
        new() { Value = InspectionStatus.Reject, Text = "Reject" },
        new() { Value = InspectionStatus.ReInspectionRequired, Text = "Re-Inspection Required" }
    };

    private List<FinalRecommendationOption> FinalRecommendationOptions = new()
    {
        new() { Value = FinalRecommendation.ApproveAsSubmitted, Text = "Approve As Submitted" },
        new() { Value = FinalRecommendation.ApproveWithModifications, Text = "Approve With Modifications" },
        new() { Value = FinalRecommendation.Reject, Text = "Reject" },
        new() { Value = FinalRecommendation.ReInspectionRequired, Text = "Re-Inspection Required" }
    };

        private string GoogleMapsKey => Config["Maps:GoogleApiKey"] ?? string.Empty;

    protected override async Task OnInitializedAsync()
    {
        Model.ApplicationId = ApplicationId;
        Model.InspectionDate = PrefilledInspectionDate ?? DateTime.Today;
        Model.InspectionAssignedTo = PrefilledAssignedTo;
        Model.Status = InspectionStatus.Pending;
        Model.FinalRecommendation = FinalRecommendation.ApproveAsSubmitted;
        Model.ClearanceOptionItemIds = new List<Guid>();
        Model.InspectionId = AssignmentId;

        await SafeExecutor.Run(() => LoadInspectorsAsync(), "SiteInspection LoadInspectors", ErrorSeverity.Warning);
        await SafeExecutor.Run(() => LoadClearanceTypesAsync(), "SiteInspection LoadClearanceTypes", ErrorSeverity.Warning);
        await SafeExecutor.Run(() => LoadExistingApplicationAsync(AssignmentId, ApplicationId), "SiteInspection LoadExisting", ErrorSeverity.Warning);
        await SafeExecutor.Run(() => CheckExistingAssignment(), "SiteInspection CheckAssignment", ErrorSeverity.Info);
    }

    private async Task LoadClearanceTypesAsync()
    {
        try
        {
            var lookups = await LookupService.LoadOptionTypesAsync(Domain.Constants.LookupCategoryNames.ClearanceTypes.ToString());
            ClearanceTypeOptions = lookups.Select(l => new ClearanceTypeOption { Value = l.Id, Text = l.Value }).ToList();
        }
        catch (Exception ex)
        {
            ClearanceTypeOptions = new();
            await ErrorNotifier.NotifyAsync(ex, "SiteInspection ClearanceTypes", ErrorSeverity.Warning);
        }
    }

    private async Task CheckExistingAssignment()
    {
        try
        {
            var client = HttpClientFactory.CreateClient("AuthorizedClient");
            var response = await client.GetAsync($"api/Assignment?id={AssignmentId}");
            if (response.IsSuccessStatusCode)
            {
                var jsonContent = await response.Content.ReadAsStringAsync();
                var assignments = System.Text.Json.JsonSerializer.Deserialize<List<AssignmentDto>>(jsonContent,
                    new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                if (assignments?.Any() == true)
                {
                    var assignment = assignments.First();
                    AssignmentId = assignment.Id;
                    IsInspectionAssigned = true;
                }
            }
        }
        catch (Exception ex)
        {
            IsInspectionAssigned = false;
            await ErrorNotifier.NotifyAsync(ex, "SiteInspection CheckAssignment", ErrorSeverity.Info);
        }
    }

    private async Task LoadInspectorsAsync()
    {
        try
        {
            var client = HttpClientFactory.CreateClient("AuthorizedClient");
            var jsonContent = await client.GetStringAsync("api/Roles/GetUsersByTenantAndRole?roleName=Inspector");
            var list = System.Text.Json.JsonSerializer.Deserialize<List<InspectorDto>>(jsonContent,
                new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
            InspectorOptions = list?.Select(x => new InspectorOption { Id = x.Id.ToString(), Name = x.FullName })?.ToList() ?? new();
        }
        catch (Exception ex)
        {
            InspectorOptions = new();
            await ErrorNotifier.NotifyAsync(ex, "SiteInspection LoadInspectors", ErrorSeverity.Warning);
        }
    }

    private async Task HandleValidSubmit()
    {
        IsSubmitting = true;
        await ErrorNotifier.NotifyMessageAsync("Submitting site inspection...", "SiteInspection", ErrorSeverity.Info);
        try
        {
            var client = HttpClientFactory.CreateClient("AuthorizedClient");
            var url = $"api/Inspection/{ApplicationId}/complete-site-inspection";
            var resp = await client.PostAsJsonAsync(url, Model);
            if (resp.IsSuccessStatusCode)
            {
                // Option B: persist clearance selections separately
                if (Model.ClearanceOptionItemIds != null && Model.ClearanceOptionItemIds.Any() && ModuleId != Guid.Empty)
                {
                    var saveSelectionsUrl = "api/Lookups/entity-options/selections/save";
                    var saveRequest = new SaveEntityOptionSelectionsRequest
                    {
                        EntityId = ApplicationId,
                        EntityType = "SiteInspection",
                        ModuleId = ModuleId,
                        LookupCategoryName = LookupCategoryNames.ClearanceTypes.ToString(),
                        OptionItemIds = Model.ClearanceOptionItemIds
                    };
                    try
                    {
                        var saveResp = await client.PostAsJsonAsync(saveSelectionsUrl, saveRequest);
                        if (!saveResp.IsSuccessStatusCode)
                        {
                            await ErrorNotifier.NotifyMessageAsync("Clearance selections save failed", "SiteInspection", ErrorSeverity.Warning);
                        }
                    }
                    catch (Exception ex)
                    {
                        await ErrorNotifier.NotifyAsync(ex, "SiteInspection SaveSelections", ErrorSeverity.Warning);
                    }
                }

                if (OnSubmit.HasDelegate)
                    await OnSubmit.InvokeAsync(Model);
                if (OnInspectionCompleted.HasDelegate)
                    await OnInspectionCompleted.InvokeAsync();

                await ErrorNotifier.NotifyMessageAsync("Site inspection submitted", "SiteInspection", ErrorSeverity.Success);
            }
            else
            {
                var error = await resp.Content.ReadAsStringAsync();
                await ErrorNotifier.NotifyMessageAsync($"Submit failed: {TrimForUi(error)}", "SiteInspection", ErrorSeverity.Error);
            }
        }
        catch (Exception ex)
        {
            await ErrorNotifier.NotifyAsync(ex, "SiteInspection Submit", ErrorSeverity.Error);
        }
        finally
        {
            IsSubmitting = false;
        }
    }

    private async Task LoadExistingApplicationAsync(Guid? AssignmentId, Guid ApplicationId)
    {
        try
        {
            var client = HttpClientFactory.CreateClient("AuthorizedClient");
            try
            {
                var jsonInsp = await client.GetStringAsync($"api/Inspection/{AssignmentId}");
                var existingInspection = System.Text.Json.JsonSerializer.Deserialize<SiteInspectionResponse>(jsonInsp,
                    new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                if (existingInspection != null)
                {
                    PopulateFormFromExistingInspection(existingInspection);
                    await ErrorNotifier.NotifyMessageAsync("Existing inspection loaded", "SiteInspection", ErrorSeverity.Info);
                }
            }
            catch (Exception ex)
            {
                await ErrorNotifier.NotifyAsync(ex, "SiteInspection LoadExistingInspection", ErrorSeverity.Warning);
            }

            if (ModuleId != Guid.Empty)
            {
                try
                {
                    var jsonDocs = await client.GetStringAsync($"api/Documents/linked?moduleId={ModuleId}&entityId={ApplicationId}&linkContext={MuniLK.Domain.Constants.LookupValues.DocumentTypes.Inspection.ToString()}");
                    var documents = System.Text.Json.JsonSerializer.Deserialize<List<DocumentLinkResponse>>(jsonDocs,
                        new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                    ApplicationDocuments = documents ?? new List<DocumentLinkResponse>();
                }
                catch (Exception ex)
                {
                    ApplicationDocuments = new List<DocumentLinkResponse>();
                    await ErrorNotifier.NotifyAsync(ex, "SiteInspection LoadDocuments", ErrorSeverity.Warning);
                }
            }

            if (ModuleId != Guid.Empty)
            {
                try
                {
                    var selections = await client.GetFromJsonAsync<List<Guid>>($"api/Lookups/entity-options/selections?entityId={ApplicationId}&entityType=SiteInspection&moduleId={ModuleId}");
                    if (selections != null && selections.Any())
                        Model.ClearanceOptionItemIds = selections;
                }
                catch (Exception ex)
                {
                    await ErrorNotifier.NotifyAsync(ex, "SiteInspection LoadSelections", ErrorSeverity.Warning);
                }
            }
        }
        catch (Exception ex)
        {
            ApplicationDocuments = new List<DocumentLinkResponse>();
            await ErrorNotifier.NotifyAsync(ex, "SiteInspection LoadExistingApplication", ErrorSeverity.Error);
        }
    }

    private async Task DownloadDocument(DocumentLinkResponse document)
    {
        var (fileName, base64) = await DocClient.DownloadDocumentAsync(document);
        if (string.IsNullOrWhiteSpace(fileName) || string.IsNullOrWhiteSpace(base64))
        {
            await ErrorNotifier.NotifyMessageAsync("Document download failed", "SiteInspection Document", ErrorSeverity.Warning);
            return;
        }
        try
        {
            await JS.InvokeVoidAsync("downloadBase64File", fileName, base64);
            await ErrorNotifier.NotifyMessageAsync("Document downloaded", "SiteInspection Document", ErrorSeverity.Info);
        }
        catch (JSException ex)
        {
            await ErrorNotifier.NotifyAsync(ex, "SiteInspection DocumentDownload", ErrorSeverity.Warning);
        }
    }

    private async Task OnPlanUploaded(string fileName)
    {
        if (!string.IsNullOrWhiteSpace(fileName))
            await ErrorNotifier.NotifyMessageAsync("Document uploaded", "SiteInspection Document", ErrorSeverity.Success);
    }

    private static string TrimForUi(string raw)
    {
        if (string.IsNullOrWhiteSpace(raw)) return raw;
        var trimmed = raw.Replace("\r", " ").Replace("\n", " ");
        return trimmed.Length > 300 ? trimmed.Substring(0, 300) + "‚Ä¶" : trimmed;
    }

    private class AssignmentDto
    {
        public Guid Id { get; set; }
        public Guid AssignedToUserId { get; set; }
        public DateTime AssignmentDate { get; set; }
        public string? Status { get; set; }
    }
    public class InspectionStatusOption
    {
        public InspectionStatus Value { get; set; }
        public string Text { get; set; } = "";
    }
    public class FinalRecommendationOption
    {
        public FinalRecommendation Value { get; set; }
        public string Text { get; set; } = "";
    }
    public class ClearanceTypeOption
    {
        public Guid Value { get; set; }
        public string Text { get; set; } = "";
    }
    private class InspectorOption
    {
        public string Id { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
    }
    private class InspectorDto
    {
        public Guid Id { get; set; }
        public string FullName { get; set; } = string.Empty;
    }
    private class SaveEntityOptionSelectionsRequest
    {
        public Guid EntityId { get; set; }
        public string EntityType { get; set; } = string.Empty;
        public Guid ModuleId { get; set; }
        public string LookupCategoryName { get; set; } = string.Empty;
        public List<Guid> OptionItemIds { get; set; } = new();
    }
    private void PopulateFormFromExistingInspection(SiteInspectionResponse inspection)
    {
        Model.Status = inspection.Status;
        Model.InspectionDate = inspection.InspectionDate;
        Model.InspectionAssignedTo = inspection.OfficersPresent ?? string.Empty;
        Model.Remarks = inspection.Remarks ?? string.Empty;
        Model.PropertyAddress = PropertyAddress;
        var siteConditions = inspection.SiteConditions ?? new List<SiteConditionResult>();
        var accessRoad = siteConditions.FirstOrDefault(sc => sc.Name == "AccessRoadWidth");
        Model.AccessRoadWidthCondition = accessRoad?.Result;
        Model.AccessRoadWidthNotes = accessRoad?.Notes ?? string.Empty;
        var boundary = siteConditions.FirstOrDefault(sc => sc.Name == "BoundaryVerification");
        Model.BoundaryVerification = boundary?.Result;
        Model.BoundaryVerificationNotes = boundary?.Notes ?? string.Empty;
        var topography = siteConditions.FirstOrDefault(sc => sc.Name == "Topography");
        Model.Topography = topography?.Result;
        Model.TopographyNotes = topography?.Notes ?? string.Empty;
        var structures = siteConditions.FirstOrDefault(sc => sc.Name == "ExistingStructures");
        Model.ExistingStructures = structures?.Result;
        Model.ExistingStructuresNotes = structures?.Notes ?? string.Empty;
        var encroachments = siteConditions.FirstOrDefault(sc => sc.Name == "Encroachments");
        Model.EncroachmentsReservations = encroachments?.Result;
        Model.EncroachmentsReservationsNotes = encroachments?.Notes ?? string.Empty;
        var complianceChecks = inspection.ComplianceChecks ?? new List<ComplianceCheckResult>();
        var surveyPlan = complianceChecks.FirstOrDefault(cc => cc.Name == "MatchesSurveyPlan");
        Model.MatchesSurveyPlan = surveyPlan?.Result;
        Model.MatchesSurveyPlanNotes = surveyPlan?.Notes ?? string.Empty;
        var zoning = complianceChecks.FirstOrDefault(cc => cc.Name == "ZoningCompatible");
        Model.ZoningCompatible = zoning?.Result;
        Model.ZoningCompatibleNotes = zoning?.Notes ?? string.Empty;
        var setbacks = complianceChecks.FirstOrDefault(cc => cc.Name == "SetbacksObserved");
        Model.SetbacksObserved = setbacks?.Result;
        Model.SetbacksObservedNotes = setbacks?.Notes ?? string.Empty;
        var frontSetback = complianceChecks.FirstOrDefault(cc => cc.Name == "FrontSetback");
        Model.FrontSetback = frontSetback?.Result ?? false;
        var rearSetback = complianceChecks.FirstOrDefault(cc => cc.Name == "RearSetback");
        Model.RearSetback = rearSetback?.Result ?? false;
        var sideSetbacks = complianceChecks.FirstOrDefault(cc => cc.Name == "SideSetbacks");
        Model.SideSetbacks = sideSetbacks?.Result ?? false;
        var environmental = complianceChecks.FirstOrDefault(cc => cc.Name == "EnvironmentalConcerns");
        Model.EnvironmentalConcerns = environmental?.Result;
        Model.EnvironmentalConcernsNotes = environmental?.Notes ?? string.Empty;
        Model.RequiredModifications = inspection.RequiredModifications ?? string.Empty;
        Model.ClearanceOptionItemIds = inspection.ClearanceOptionItemIds ?? new List<Guid>();
        Model.FinalRecommendation = inspection.FinalRecommendation;
    }
    private bool _showMapDialog = false;
    private void ShowMapDialog() => _showMapDialog = true;
    private string GetGoogleMapsEmbedUrl(string address)
    {
        var encoded = System.Web.HttpUtility.UrlEncode(address);
        if (string.IsNullOrWhiteSpace(GoogleMapsKey))
            return $"https://www.google.com/maps?q={encoded}&output=embed";
        return $"https://www.google.com/maps/embed/v1/place?key={GoogleMapsKey}&q={encoded}";
    }

    private void PreviewDocument(DocumentLinkResponse document)
    {
        SelectedPreviewDocument = document;
        IsPreviewDialogVisible = true;
    }
}