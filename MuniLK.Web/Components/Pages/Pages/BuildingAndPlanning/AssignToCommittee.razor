@using MuniLK.Application.BuildingAndPlanning.DTOs
@using MuniLK.Application.Contact.DTOs
@using MuniLK.Application.PlanningCommitteeMeetings.DTOs
@using MuniLK.Domain.Constants.Flows
@using MuniLK.Web.Services
@using Syncfusion.Blazor.Buttons
@using Syncfusion.Blazor.Popups
@inject IHttpClientFactory HttpClientFactory
@inject ISafeExecutor SafeExecutor
@inject ErrorNotifier ErrorNotifier

<div class="container-xxl py-3">
    <div class="card shadow-sm position-relative">
        <div class="card-header bg-light d-flex align-items-center justify-content-between">
            <h5 class="mb-0">Assign to Planning Committee Meeting</h5>
            <div class="d-flex align-items-center gap-2">
                @if (!string.IsNullOrWhiteSpace(ApplicationNumber))
                {
                    <span class="badge bg-primary-subtle text-primary">App No: @ApplicationNumber</span>
                }
                @if (HasExistingSchedule)
                {
                    <span class="badge bg-info-subtle text-info-emphasis">Scheduled</span>
                }
            </div>
        </div>
        <div class="card-body">
            @if (InitialLoading)
            {
                <div class="p-3 text-center"><SfSpinner Visible="true" /></div>
            }
            else
            {
                @if (HasExistingSchedule && SelectedMeetingId.HasValue)
                {
                    <div class="alert alert-success d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Scheduled:</strong> @MeetingDateDisplay @("(" + DisplayChairperson + ")") | Venue: @Meetings.FirstOrDefault(x=>x.Id==SelectedMeetingId)?.Venue
                        </div>
                        <SfButton CssClass="btn btn-sm btn-outline-secondary" OnClick="OpenDialog"><i class="fas fa-edit me-1"></i>Change</SfButton>
                    </div>
                }
                else
                {
                    <div class="alert alert-info d-flex justify-content-between align-items-center">
                        <span>No committee meeting assigned yet. Assign now.</span>
                        <SfButton CssClass="btn btn-sm btn-primary" OnClick="OpenDialog">@PrimaryActionText</SfButton>
                    </div>
                }
            }

            <SfDialog @bind-Visible="DialogVisible" Width="900px" IsModal="true" CssClass="assign-committee-dialog" Header="@PrimaryActionText">
                <DialogTemplates>
                    <Content>
                        <div class="mb-3">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" id="modeExisting" checked="@UseExisting" @onchange="_ => SetMode(true)" />
                                <label class="form-check-label" for="modeExisting">Select Existing Meeting</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" id="modeNew" checked="@(!UseExisting)" @onchange="_ => SetMode(false)" />
                                <label class="form-check-label" for="modeNew">Create New Meeting</label>
                            </div>
                        </div>

                        @if (UseExisting)
                        {
                            <div class="mb-2 d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">Upcoming Scheduled Meetings</h6>
                                <SfButton CssClass="btn btn-sm btn-outline-secondary" OnClick="RefreshMeetings"><i class="fas fa-sync"></i></SfButton>
                            </div>
                            @if (IsLoadingMeetings)
                            {
                                <div class="p-3 text-center"><SfSpinner Visible="true" /></div>
                            }
                            else if (MeetingLoadError != null)
                            {
                                <div class="alert alert-danger">@MeetingLoadError</div>
                            }
                            else if (Meetings.Count == 0)
                            {
                                <div class="alert alert-info">No scheduled meetings found in range.</div>
                            }
                            else
                            {
                                <div class="table-responsive" style="max-height:300px; overflow-y:auto;">
                                    <table class="table table-sm table-hover align-middle mb-2">
                                        <thead class="table-light">
                                            <tr>
                                                <th></th>
                                                <th>Date</th>
                                                <th>Time</th>
                                                <th>Venue</th>
                                                <th>Chairperson</th>
                                                <th>Apps</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var m in Meetings.OrderBy(x => x.StartTime))
                                            {
                                                var alreadyAttached = m.ApplicationIds.Contains(ApplicationId);
                                                <tr class="@(SelectedMeetingId == m.Id ? "table-primary" : string.Empty)">
                                                    <td>
                                                        <input type="radio" name="meetingSelect" value="@m.Id" checked="@(SelectedMeetingId == m.Id)" @onchange="_ => SelectMeeting(m.Id)" />
                                                    </td>
                                                    <td>@m.StartTime.ToString("dd MMM yyyy")</td>
                                                    <td>@m.StartTime.ToString("HH:mm") - @m.EndTime.ToString("HH:mm")</td>
                                                    <td>@m.Venue</td>
                                                    <td>@GetContactName(m.ChairpersonContactId)</td>
                                                    <td>@m.ApplicationIds.Count</td>
                                                    <td><span class="badge @(m.Status switch { PlanningCommitteeMeetingStatus.Scheduled => "bg-info", PlanningCommitteeMeetingStatus.Completed => "bg-success", PlanningCommitteeMeetingStatus.Cancelled => "bg-secondary", _ => "bg-light" })">@m.Status</span></td>
                                                </tr>
                                                @if (SelectedMeetingId == m.Id)
                                                {
                                                    <tr class="bg-light">
                                                        <td colspan="7">
                                                            <div class="small">Subject: <strong>@m.Subject</strong> | Agenda: @m.Agenda</div>
                                                            <div class="small">Members: @m.MemberContactIds.Count (excl. chairperson)</div>
                                                            @if (alreadyAttached)
                                                            {
                                                                <div class="text-success small mt-1"><i class="fas fa-check-circle"></i> This application is already attached to this meeting.</div>
                                                            }
                                                        </td>
                                                    </tr>
                                                }
                                            }
                                        </tbody>
                                    </table>
                                </div>
                                <div class="d-flex justify-content-end gap-2">
                                    <SfButton CssClass="btn btn-outline-primary" OnClick="OpenScheduler"><i class="fas fa-calendar-plus me-1"></i>New Meeting</SfButton>
                                    <SfButton CssClass="btn btn-primary" Disabled="@(!CanAttach)" OnClick="AttachToExistingMeeting">
                                        <i class="fas fa-link me-1"></i>Attach Application
                                    </SfButton>
                                </div>
                                @if (!string.IsNullOrWhiteSpace(ExistingModeError))
                                {
                                    <div class="alert alert-danger mt-2">@ExistingModeError</div>
                                }
                            }
                        }
                        else
                        {
                            <div class="alert alert-info">
                                Use the meeting scheduler to create a new committee meeting. Once you close it, refresh and attach.
                            </div>
                            <SfButton CssClass="btn btn-outline-primary" OnClick="OpenScheduler"><i class="fas fa-calendar-plus me-1"></i>Open Meeting Scheduler</SfButton>
                        }
                    </Content>
                </DialogTemplates>
                <DialogButtons>
                    <DialogButton Content="Close" OnClick="() => DialogVisible = false" />
                </DialogButtons>
            </SfDialog>

            <SfDialog @bind-Visible="SchedulerVisible" Width="1100px" IsModal="true" Header="Planning Committee Scheduler" ShowCloseIcon="true">
                <DialogTemplates>
                    <Content>
                        <PlanningCommitteeScheduler />
                    </Content>
                </DialogTemplates>
                <DialogButtons>
                    <DialogButton Content="Done" IsPrimary="true" OnClick="OnSchedulerClosed" />
                </DialogButtons>
            </SfDialog>

            @if (!InitialLoading && HasExistingSchedule && SelectedMeetingId.HasValue)
            {
                <hr />
                <h6>Current Schedule</h6>
                <ul class="list-group list-group-flush better-list">
                    <li class="list-group-item px-0"><span class="label">Meeting Date</span><span class="value">@MeetingDateDisplay</span></li>
                    <li class="list-group-item px-0"><span class="label">Chairperson</span><span class="value">@DisplayChairperson</span></li>
                    <li class="list-group-item px-0"><span class="label">Venue</span><span class="value">@Meetings.FirstOrDefault(x=>x.Id==SelectedMeetingId)?.Venue</span></li>
                    <li class="list-group-item px-0"><span class="label">Members Count</span><span class="value">@CurrentMembersCount</span></li>
                </ul>
            }
        </div>
    </div>
</div>

@code {
    [Parameter] public Guid ApplicationId { get; set; }
    [Parameter] public string? ApplicationNumber { get; set; }
    [Parameter] public EventCallback OnScheduled { get; set; }

    private bool DialogVisible = false;
    private bool SchedulerVisible = false;
    private bool UseExisting = true;

    private List<PlanningCommitteeMeetingResponse> Meetings = new();
    private Guid? SelectedMeetingId;
    private bool IsLoadingMeetings = false;
    private string? MeetingLoadError;
    private string? ExistingModeError;

    private bool HasExistingSchedule = false;
    private DateTime? MeetingDate;
    private bool InitialLoading = true;

    private string DisplayChairperson => SelectedMeetingId.HasValue ? GetContactName(Meetings.FirstOrDefault(x=>x.Id==SelectedMeetingId)?.ChairpersonContactId ?? Guid.Empty) : "-";
    private int CurrentMembersCount => SelectedMeetingId.HasValue ? Meetings.FirstOrDefault(x=>x.Id==SelectedMeetingId)?.MemberContactIds.Count ?? 0 : 0;
    private string MeetingDateDisplay => MeetingDate?.ToString("dd MMM yyyy") ?? (SelectedMeetingId.HasValue ? Meetings.FirstOrDefault(x=>x.Id==SelectedMeetingId)?.StartTime.ToString("dd MMM yyyy") ?? "-" : "-");
    private string PrimaryActionText => HasExistingSchedule ? "Reassign / Change Meeting" : "Assign to Committee";

    private List<ContactResponse> OfficerContacts = new();

    protected override async Task OnParametersSetAsync()
    {
        if (InitialLoading && ApplicationId != Guid.Empty)
        {
            await LoadOfficerContacts();
            await LoadMeetings();
            EvaluateExistingSchedule();
            InitialLoading = false;
            StateHasChanged();
        }
    }

    private void OpenDialog()
    {
        DialogVisible = true;
        if (Meetings.Count == 0) _ = LoadMeetings();
    }

    private void SetMode(bool existing)
    {
        UseExisting = existing;
        ExistingModeError = null; 
    }

    private async Task LoadMeetings()
    {
        try
        {
            IsLoadingMeetings = true; MeetingLoadError = null;
            var client = HttpClientFactory.CreateClient("AuthorizedClient");
            var list = await client.GetFromJsonAsync<List<PlanningCommitteeMeetingResponse>>($"api/PlanningCommitteeMeetings/GetMeetings?start={DateTime.UtcNow:o}&end={DateTime.UtcNow.AddDays(60):o}");
            Meetings = (list ?? new()).Where(m => m.Status == PlanningCommitteeMeetingStatus.Scheduled).ToList();
        }
        catch (Exception ex)
        {
            MeetingLoadError = ex.Message;
        }
        finally { IsLoadingMeetings = false; }
    }

    private void EvaluateExistingSchedule()
    {
        var upcoming = Meetings.FirstOrDefault(m => m.Status == PlanningCommitteeMeetingStatus.Scheduled && m.ApplicationIds.Contains(ApplicationId) && m.EndTime >= DateTime.UtcNow);
        if (upcoming != null)
        {
            HasExistingSchedule = true;
            SelectedMeetingId = upcoming.Id;
            MeetingDate = upcoming.StartTime;
        }
    }

    private async Task RefreshMeetings()
    {
        await LoadMeetings();
        EvaluateExistingSchedule();
    }

    private void SelectMeeting(Guid id)
    {
        SelectedMeetingId = id; ExistingModeError = null;
    }

    private bool CanAttach => SelectedMeetingId.HasValue && Meetings.FirstOrDefault(m => m.Id == SelectedMeetingId) is { } sel && !sel.ApplicationIds.Contains(ApplicationId);

    private async Task AttachToExistingMeeting()
    {
        if (!SelectedMeetingId.HasValue)
        {
            ExistingModeError = "Please select a meeting."; return;
        }
        var meeting = Meetings.FirstOrDefault(m => m.Id == SelectedMeetingId);
        if (meeting == null) { ExistingModeError = "Meeting not found."; return; }
        if (meeting.ApplicationIds.Contains(ApplicationId)) { ExistingModeError = "Application already attached."; return; }

        await SafeExecutor.Run(async () =>
        {
            var client = HttpClientFactory.CreateClient("AuthorizedClient");
            var resp = await client.PostAsJsonAsync($"api/PlanningCommitteeMeetings/{SelectedMeetingId}/assign-application", ApplicationId);
            if (resp.IsSuccessStatusCode)
            {
                meeting.ApplicationIds.Add(ApplicationId);
                HasExistingSchedule = true;
                MeetingDate = meeting.StartTime;
                DialogVisible = false;
                await ErrorNotifier.NotifyMessageAsync("Application attached to meeting", "AssignToCommittee", ErrorSeverity.Success);
                if (OnScheduled.HasDelegate) await OnScheduled.InvokeAsync();
            }
            else
            {
                ExistingModeError = await resp.Content.ReadAsStringAsync();
            }
        }, "AssignToCommittee Attach", ErrorSeverity.Error);
    }

    private async Task LoadOfficerContacts()
    {
        try
        {
            var client = HttpClientFactory.CreateClient("AuthorizedClient");
            var list = await client.GetFromJsonAsync<List<ContactResponse>>($"api/Roles/GetUsersByTenantAndRole?roleName={MuniLK.Domain.Constants.Roles.Inspector}");
            OfficerContacts = list ?? new();
        }
        catch { OfficerContacts = new(); }
    }

    private void OpenScheduler() => SchedulerVisible = true;

    private async Task OnSchedulerClosed()
    {
        SchedulerVisible = false;
        await LoadMeetings();
        EvaluateExistingSchedule();
    }

    private string GetContactName(Guid id) => OfficerContacts.FirstOrDefault(c => c.Id == id)?.FullName ?? "-";
}

<style>
    .assign-committee-dialog .e-dlg-content { max-height: 70vh; overflow-y:auto; }
    .assign-committee-dialog table tbody tr { cursor:pointer; }
</style>
